FROM node:16

# Make a directory for the service
WORKDIR /usr/src/candles

# Install Yarn
RUN apt-get -y update \
	&& apt-get -y install yarn \
	&& apt-get clean

# Install dependencies
ADD ./package.json ./yarn.lock ./

RUN git clone https://github.com/alphabotsystem/dependencies.git && cd ./dependencies && git checkout v1.4.7
RUN yarn add ./dependencies/js/parser/
RUN yarn
RUN rm -r ./dependencies

# Copy source code
COPY ./app ./app

# Pass required credentials
ENV GOOGLE_APPLICATION_CREDENTIALS="/run/secrets/google-cloud-auth/key"

# Run
ENTRYPOINT ["node", "app/candle_server.js"]